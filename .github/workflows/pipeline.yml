name: Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  test:
    name: Test & Build
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Test
        run: pnpm test

      - name: Accuracy Benchmark Gate
        run: pnpm accuracy:check

  release:
    name: Release
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    outputs:
      cli_version: ${{ steps.capture_version.outputs.cli_version }}
      did_release: ${{ steps.release_guard.outputs.skip_release != 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@v3
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Verify brain package executables
        run: pnpm verify:brain-packages

      - name: Verify release readiness
        run: pnpm verify:release

      - name: Detect existing release tag on HEAD
        id: release_guard
        run: |
          set -euo pipefail
          EXISTING_TAG=$(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1 || true)
          if [ -n "${EXISTING_TAG}" ]; then
            echo "Found existing release tag on HEAD: ${EXISTING_TAG}. Skipping semantic-release rerun."
            echo "skip_release=true" >> "$GITHUB_OUTPUT"
            echo "existing_tag=${EXISTING_TAG}" >> "$GITHUB_OUTPUT"
          else
            echo "No release tag on HEAD. Proceeding with semantic-release."
            echo "skip_release=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Authenticate with NPM
        if: steps.release_guard.outputs.skip_release != 'true'
        run: |
          npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}
          pnpm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Release
        if: steps.release_guard.outputs.skip_release != 'true'
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Capture released CLI version
        id: capture_version
        run: |
          if [ "${{ steps.release_guard.outputs.skip_release }}" = "true" ]; then
            VERSION="${{ steps.release_guard.outputs.existing_tag }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(node -p "require('./packages/rigour-cli/package.json').version")
          fi
          echo "cli_version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Publish Homebrew Formula
        if: success() && steps.release_guard.outputs.skip_release != 'true'
        env:
          HOMEBREW_TAP_GH_TOKEN: ${{ secrets.HOMEBREW_TAP_GH_TOKEN }}
          HOMEBREW_TAP_REPO: ${{ vars.HOMEBREW_TAP_REPO || 'rigour-labs/homebrew-tap' }}
        run: |
          set -euo pipefail

          if [ -z "${HOMEBREW_TAP_GH_TOKEN:-}" ]; then
            echo "HOMEBREW_TAP_GH_TOKEN is not set. Skipping Homebrew publish."
            exit 0
          fi

          VERSION=$(node -p "require('./packages/rigour-cli/package.json').version")
          TARBALL_URL="https://registry.npmjs.org/@rigour-labs/cli/-/cli-${VERSION}.tgz"
          TARBALL_PATH="/tmp/rigour-cli-${VERSION}.tgz"

          echo "Preparing Homebrew formula for version ${VERSION}"
          curl -fsSL "${TARBALL_URL}" -o "${TARBALL_PATH}"
          SHA256=$(sha256sum "${TARBALL_PATH}" | awk '{print $1}')

          TAP_DIR="/tmp/homebrew-tap"
          rm -rf "${TAP_DIR}"
          git clone "https://x-access-token:${HOMEBREW_TAP_GH_TOKEN}@github.com/${HOMEBREW_TAP_REPO}.git" "${TAP_DIR}"

          mkdir -p "${TAP_DIR}/Formula"
          cat > "${TAP_DIR}/Formula/rigour.rb" <<EOF
          class Rigour < Formula
            desc "Rigour CLI quality gates for AI-generated code"
            homepage "https://github.com/rigour-labs/rigour"
            url "${TARBALL_URL}"
            sha256 "${SHA256}"
            license "MIT"

            depends_on "node"

            def install
              system "npm", "install", *std_npm_args(prefix: libexec)
              bin.install_symlink Dir["#{libexec}/bin/*"]
            end

            test do
              system "#{bin}/rigour", "--version"
            end
          end
          EOF

          cd "${TAP_DIR}"
          ruby -c Formula/rigour.rb
          grep -q 'std_npm_args(prefix: libexec)' Formula/rigour.rb
          if grep -q 'std_npm_args(libexec)' Formula/rigour.rb; then
            echo "Invalid Homebrew formula: legacy std_npm_args(libexec) detected."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/rigour.rb
          if git diff --cached --quiet; then
            echo "Homebrew formula already up to date."
            exit 0
          fi
          git commit -m "chore: bump rigour to v${VERSION}"
          git push origin HEAD
          echo "Homebrew formula updated in ${HOMEBREW_TAP_REPO}"

      - name: Publish to MCP Registry
        if: success() && steps.release_guard.outputs.skip_release != 'true'
        working-directory: packages/rigour-mcp
        run: |
          # Get the version from the package.json which was just updated by semantic-release
          VERSION=$(node -p "require('./package.json').version")
          
          echo "Syncing server.json to version $VERSION"
          jq ".version = \"$VERSION\" | .packages[0].version = \"$VERSION\"" server.json > server.json.tmp && mv server.json.tmp server.json
          
          curl -sL "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          chmod +x mcp-publisher
          ./mcp-publisher login github-oidc
          ./mcp-publisher publish

  distribution-smoke:
    name: Distribution Smoke
    needs: release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.release.outputs.did_release == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    env:
      EXPECTED_CLI_VERSION: ${{ needs.release.outputs.cli_version }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'

      - name: Verify npx command
        run: |
          node -e 'const { execSync } = require("child_process"); const expected = process.env.EXPECTED_CLI_VERSION; const out = execSync("npx -y @rigour-labs/cli --version", { encoding: "utf8" }); const versions = out.match(/\d+\.\d+\.\d+/g) || []; const actual = versions[versions.length - 1]; if (!actual) { console.error("No CLI version found in output"); process.exit(1); } if (expected && actual !== expected) { console.error("npx version mismatch: expected " + expected + ", got " + actual); process.exit(1); } console.log("npx version OK: " + actual);'

      - name: Verify global npm install
        run: |
          npm install -g @rigour-labs/cli
          node -e 'const { execSync } = require("child_process"); const expected = process.env.EXPECTED_CLI_VERSION; const out = execSync("rigour --version", { encoding: "utf8" }); const versions = out.match(/\d+\.\d+\.\d+/g) || []; const actual = versions[versions.length - 1]; if (!actual) { console.error("No global CLI version found in output"); process.exit(1); } if (expected && actual !== expected) { console.error("global npm version mismatch: expected " + expected + ", got " + actual); process.exit(1); } console.log("global npm version OK: " + actual);'

      - name: Verify hooks checker command path (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/rigour-smoke
          echo "export const x = 1;" > /tmp/rigour-smoke/sample.ts
          cd /tmp/rigour-smoke
          rigour hooks check --files sample.ts

      - name: Verify hooks checker command path (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "$env:TEMP\rigour-smoke" -Force | Out-Null
          Set-Content -Path "$env:TEMP\rigour-smoke\sample.ts" -Value "export const x = 1;"
          Set-Location "$env:TEMP\rigour-smoke"
          rigour hooks check --files sample.ts

      - name: Verify Homebrew install (macOS)
        if: runner.os == 'macOS'
        run: |
          brew tap rigour-labs/tap
          brew install rigour
          node -e 'const { execSync } = require("child_process"); const expected = process.env.EXPECTED_CLI_VERSION; const out = execSync("rigour --version", { encoding: "utf8" }); const versions = out.match(/\d+\.\d+\.\d+/g) || []; const actual = versions[versions.length - 1]; if (!actual) { console.error("No brew CLI version found in output"); process.exit(1); } if (expected && actual !== expected) { console.error("brew version mismatch: expected " + expected + ", got " + actual); process.exit(1); } console.log("brew version OK: " + actual);'
