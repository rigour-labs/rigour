name: Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  test:
    name: Test & Build
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Test
        run: pnpm test

  release:
    name: Release
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@v3
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Authenticate with NPM
        run: |
          npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}
          pnpm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Release
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish Homebrew Formula
        if: success()
        env:
          HOMEBREW_TAP_GH_TOKEN: ${{ secrets.HOMEBREW_TAP_GH_TOKEN }}
          HOMEBREW_TAP_REPO: ${{ vars.HOMEBREW_TAP_REPO || 'rigour-labs/homebrew-tap' }}
        run: |
          set -euo pipefail

          if [ -z "${HOMEBREW_TAP_GH_TOKEN:-}" ]; then
            echo "HOMEBREW_TAP_GH_TOKEN is not set. Skipping Homebrew publish."
            exit 0
          fi

          VERSION=$(node -p "require('./packages/rigour-cli/package.json').version")
          TARBALL_URL="https://registry.npmjs.org/@rigour-labs/cli/-/cli-${VERSION}.tgz"
          TARBALL_PATH="/tmp/rigour-cli-${VERSION}.tgz"

          echo "Preparing Homebrew formula for version ${VERSION}"
          curl -fsSL "${TARBALL_URL}" -o "${TARBALL_PATH}"
          SHA256=$(sha256sum "${TARBALL_PATH}" | awk '{print $1}')

          TAP_DIR="/tmp/homebrew-tap"
          rm -rf "${TAP_DIR}"
          git clone "https://x-access-token:${HOMEBREW_TAP_GH_TOKEN}@github.com/${HOMEBREW_TAP_REPO}.git" "${TAP_DIR}"

          mkdir -p "${TAP_DIR}/Formula"
          cat > "${TAP_DIR}/Formula/rigour.rb" <<EOF
          class Rigour < Formula
            desc "Rigour CLI quality gates for AI-generated code"
            homepage "https://github.com/rigour-labs/rigour"
            url "${TARBALL_URL}"
            sha256 "${SHA256}"
            license "MIT"

            depends_on "node"

            def install
              system "npm", "install", *std_npm_args(libexec)
              bin.install_symlink Dir["#{libexec}/bin/*"]
            end

            test do
              system "#{bin}/rigour", "--version"
            end
          end
          EOF

          cd "${TAP_DIR}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/rigour.rb
          if git diff --cached --quiet; then
            echo "Homebrew formula already up to date."
            exit 0
          fi
          git commit -m "chore: bump rigour to v${VERSION}"
          git push origin HEAD
          echo "Homebrew formula updated in ${HOMEBREW_TAP_REPO}"

      - name: Publish to MCP Registry
        if: success()
        working-directory: packages/rigour-mcp
        run: |
          # Get the version from the package.json which was just updated by semantic-release
          VERSION=$(node -p "require('./package.json').version")
          
          echo "Syncing server.json to version $VERSION"
          jq ".version = \"$VERSION\" | .packages[0].version = \"$VERSION\"" server.json > server.json.tmp && mv server.json.tmp server.json
          
          curl -sL "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_linux_amd64.tar.gz" | tar xz
          chmod +x mcp-publisher
          ./mcp-publisher login github-oidc
          ./mcp-publisher publish
